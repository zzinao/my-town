{"ast":null,"code":"import { createAction, handleActions } from 'redux-actions';\nimport { produce } from 'immer';\nimport { realtime } from '../../shared/firebase';\nimport firebase from 'firebase/compat/app';\nimport { getDocs, doc, addDoc, collection, query, where, orderBy, updateDoc, increment } from 'firebase/firestore';\nimport { db } from '../../shared/firebase';\nimport { actionCreators as postActions } from './post';\nimport { ref, update } from 'firebase/database';\nimport moment from 'moment';\nconst SET_COMMENT = 'SET_COMMENT';\nconst ADD_COMMENT = 'ADD_COMMENT';\nconst LOADING = 'LOADING';\nconst setComment = createAction(SET_COMMENT, (post_id, comment_list) => ({\n  post_id,\n  comment_list\n}));\nconst addComment = createAction(ADD_COMMENT, (post_id, comment) => ({\n  post_id,\n  comment\n}));\nconst loading = createAction(LOADING, is_loading => ({\n  is_loading\n}));\nconst initialState = {\n  list: {},\n  is_loading: false\n};\n\nconst addCommentFB = (post_id, contents) => {\n  return async function (dispatch, getState, _ref) {\n    let {\n      history\n    } = _ref;\n    // const commentDB = collection(db, 'comment')\n    const user_info = getState().user.user;\n    const postDB = collection(db, 'comment');\n    const post = getState().post.list.find(l => l.id === post_id);\n    let comment = {\n      post_id: post_id,\n      user_id: user_info.uid,\n      user_name: user_info.user_name,\n      user_profile: user_info.user_profile,\n      contents: contents,\n      insert_dt: moment().format('YYYY-MM-DD hh:mm')\n    };\n    await addDoc(postDB, comment).then(async i => {\n      const post = getState().post.list.find(l => l.id === post_id);\n      comment = { ...comment,\n        id: i.id\n      }; //   const increment = firebase.firestore.FieldValue.increment(1){ comment_cnt: increment }\n      //   comment = { ...comment, id: doc.id }\n\n      await updateDoc(doc(db, 'post', post_id), {\n        comment_cnt: increment(1)\n      }).then(async _post => {\n        dispatch(addComment(post_id, comment));\n\n        if (post) {\n          dispatch(postActions.editPost(post_id, {\n            comment_cnt: parseInt(post.comment_cnt) + 1\n          }));\n\n          const _noti_item = ref(realtime, `noti/${post.user_info.user_id}/list`);\n\n          await push(noti_item, {\n            post_id: post_id,\n            user_name: comment.user_name,\n            image_url: post.image_url,\n            insert_dt: comment.insert_dt\n          }).then(res => {\n            const notiDB = ref(rtdb, `noti/${post.user_info.user_id}`);\n            update(notiDB, {\n              read: false\n            });\n          });\n        }\n      });\n    });\n  };\n};\n\nconst getCommentFB = function () {\n  let post_id = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;\n  return async function (dispatch, getState, _ref2) {\n    let {\n      history\n    } = _ref2;\n\n    if (!post_id) {\n      return;\n    }\n\n    const commentDB = collection(db, 'comment');\n    console.log(commentDB);\n    let list = [];\n    const q = query(commentDB, where('post_id', '==', post_id), orderBy('insert_dt', 'desc'));\n    await getDocs(q).then(docs => {\n      docs.forEach(doc => {\n        console.log(doc.data());\n        list.push({ ...doc.data(),\n          id: doc.id\n        });\n      });\n      console.log(list);\n      dispatch(setComment(post_id, list));\n    }).catch(err => {\n      console.log('댓글 정보를 가져올 수가 ....', err);\n    });\n  };\n};\n\nexport default handleActions({\n  [SET_COMMENT]: (state, action) => produce(state, draft => {\n    //let date ={[post_id]: com_list...}\n    draft.list[action.payload.post_id] = action.payload.comment_list;\n  }),\n  [ADD_COMMENT]: (state, action) => produce(state, draft => {\n    draft.list[action.payload.post_id].unshift(action.payload.comment);\n  }),\n  [LOADING]: (state, action) => produce(state, draft => {\n    draft.is_loading = action.payload.is_loading;\n  })\n}, initialState);\nconst actionCreators = {\n  getCommentFB,\n  setComment,\n  addComment,\n  addCommentFB\n};\nexport { actionCreators };","map":{"version":3,"sources":["/Users/jina/Desktop/항해99/sparta-react02/community/my_town-/src/redux/modules/comments.js"],"names":["createAction","handleActions","produce","realtime","firebase","getDocs","doc","addDoc","collection","query","where","orderBy","updateDoc","increment","db","actionCreators","postActions","ref","update","moment","SET_COMMENT","ADD_COMMENT","LOADING","setComment","post_id","comment_list","addComment","comment","loading","is_loading","initialState","list","addCommentFB","contents","dispatch","getState","history","user_info","user","postDB","post","find","l","id","user_id","uid","user_name","user_profile","insert_dt","format","then","i","comment_cnt","_post","editPost","parseInt","_noti_item","push","noti_item","image_url","res","notiDB","rtdb","read","getCommentFB","commentDB","console","log","q","docs","forEach","data","catch","err","state","action","draft","payload","unshift"],"mappings":"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","sourcesContent":["import { createAction, handleActions } from 'redux-actions'\nimport { produce } from 'immer'\nimport { realtime } from '../../shared/firebase'\nimport firebase from 'firebase/compat/app'\nimport {\n  getDocs,\n  doc,\n  addDoc,\n  collection,\n  query,\n  where,\n  orderBy,\n  updateDoc,\n  increment,\n} from 'firebase/firestore'\nimport { db } from '../../shared/firebase'\nimport { actionCreators as postActions } from './post'\nimport { ref, update } from 'firebase/database'\nimport moment from 'moment'\n\nconst SET_COMMENT = 'SET_COMMENT'\nconst ADD_COMMENT = 'ADD_COMMENT'\n\nconst LOADING = 'LOADING'\n\nconst setComment = createAction(SET_COMMENT, (post_id, comment_list) => ({\n  post_id,\n  comment_list,\n}))\nconst addComment = createAction(ADD_COMMENT, (post_id, comment) => ({\n  post_id,\n  comment,\n}))\n\nconst loading = createAction(LOADING, (is_loading) => ({ is_loading }))\n\nconst initialState = {\n  list: {},\n  is_loading: false,\n}\n\nconst addCommentFB = (post_id, contents) => {\n  return async function (dispatch, getState, { history }) {\n    // const commentDB = collection(db, 'comment')\n    const user_info = getState().user.user\n    const postDB = collection(db, 'comment')\n    const post = getState().post.list.find((l) => l.id === post_id)\n\n    let comment = {\n      post_id: post_id,\n      user_id: user_info.uid,\n      user_name: user_info.user_name,\n      user_profile: user_info.user_profile,\n      contents: contents,\n      insert_dt: moment().format('YYYY-MM-DD hh:mm'),\n    }\n\n    await addDoc(postDB, comment).then(async (i) => {\n      const post = getState().post.list.find((l) => l.id === post_id)\n      comment = { ...comment, id: i.id }\n      //   const increment = firebase.firestore.FieldValue.increment(1){ comment_cnt: increment }\n      //   comment = { ...comment, id: doc.id }\n\n      await updateDoc(doc(db, 'post', post_id), {\n        comment_cnt: increment(1),\n      }).then(async (_post) => {\n        dispatch(addComment(post_id, comment))\n\n        if (post) {\n          dispatch(\n            postActions.editPost(post_id, {\n              comment_cnt: parseInt(post.comment_cnt) + 1,\n            }),\n          )\n          const _noti_item = ref(\n            realtime,\n            `noti/${post.user_info.user_id}/list`,\n          )\n          await push(noti_item, {\n            post_id: post_id,\n            user_name: comment.user_name,\n            image_url: post.image_url,\n            insert_dt: comment.insert_dt,\n          }).then((res) => {\n            const notiDB = ref(rtdb, `noti/${post.user_info.user_id}`)\n            update(notiDB, { read: false })\n          })\n        }\n      })\n    })\n  }\n}\n\nconst getCommentFB = (post_id = null) => {\n  return async function (dispatch, getState, { history }) {\n    if (!post_id) {\n      return\n    }\n    const commentDB = collection(db, 'comment')\n    console.log(commentDB)\n    let list = []\n    const q = query(\n      commentDB,\n      where('post_id', '==', post_id),\n      orderBy('insert_dt', 'desc'),\n    )\n    await getDocs(q)\n      .then((docs) => {\n        docs.forEach((doc) => {\n          console.log(doc.data())\n          list.push({ ...doc.data(), id: doc.id })\n        })\n        console.log(list)\n        dispatch(setComment(post_id, list))\n      })\n\n      .catch((err) => {\n        console.log('댓글 정보를 가져올 수가 ....', err)\n      })\n  }\n}\n\nexport default handleActions(\n  {\n    [SET_COMMENT]: (state, action) =>\n      produce(state, (draft) => {\n        //let date ={[post_id]: com_list...}\n        draft.list[action.payload.post_id] = action.payload.comment_list\n      }),\n    [ADD_COMMENT]: (state, action) =>\n      produce(state, (draft) => {\n        draft.list[action.payload.post_id].unshift(action.payload.comment)\n      }),\n    [LOADING]: (state, action) =>\n      produce(state, (draft) => {\n        draft.is_loading = action.payload.is_loading\n      }),\n  },\n  initialState,\n)\n\nconst actionCreators = {\n  getCommentFB,\n  setComment,\n  addComment,\n  addCommentFB,\n}\n\nexport { actionCreators }\n"]},"metadata":{},"sourceType":"module"}